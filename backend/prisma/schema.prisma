generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  EMPLOYEE
}

enum VisitStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REVIEWED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum NoteType {
  TEXT
  CHECKLIST
}

enum NoteColor {
  DEFAULT
  RED
  ORANGE
  YELLOW
  GREEN
  TEAL
  BLUE
  PURPLE
  GRAY
}

enum ChatType {
  ONE_ON_ONE
  GROUP
}

enum MessageType {
  TEXT
  IMAGE
  FILE
}

enum ParticipantRole {
  ADMIN
  MEMBER
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(EMPLOYEE)
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schoolsCreated   School[]          @relation("SchoolCreatedBy")
  visits           SchoolVisit[]
  notes            Note[]
  labelsCreated    NoteLabel[]       @relation("NoteLabelCreatedBy")
  chatsCreated     Chat[]            @relation("ChatCreatedBy")
  chatParticipants ChatParticipant[]
  messagesSent     Message[]

  @@map("users")
}

model School {
  id            String   @id @default(uuid())
  name          String
  location      String
  address       String?
  contactPerson String?
  contactPhone  String?
  district      String?
  state         String?
  pincode       String?
  latitude      Float?
  longitude     Float?
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  createdBy User          @relation("SchoolCreatedBy", fields: [createdById], references: [id])
  visits    SchoolVisit[]
  notes     Note[]

  @@index([name])
  @@index([location])
  @@map("schools")
}

model SchoolVisit {
  id         String      @id @default(uuid())
  schoolId   String
  employeeId String
  visitDate  DateTime
  status     VisitStatus @default(PENDING)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  school       School             @relation(fields: [schoolId], references: [id])
  employee     User               @relation(fields: [employeeId], references: [id])
  requirements SchoolRequirement?
  images       VisitImage[]
  notes        Note[]

  @@index([employeeId])
  @@index([visitDate])
  @@map("school_visits")
}

model SchoolRequirement {
  id      String @id @default(uuid())
  visitId String @unique

  // Core Requirements
  booksNeeded           Boolean @default(false)
  booksQuantity         Int?
  uniformsNeeded        Boolean @default(false)
  uniformsQuantity      Int?
  furnitureNeeded       Boolean @default(false)
  furnitureDetails      String?
  paintingNeeded        Boolean @default(false)
  paintingArea          String?
  otherCoreRequirements String?

  // Development Requirements
  tvNeeded             Boolean @default(false)
  tvQuantity           Int?
  wifiNeeded           Boolean @default(false)
  wifiDetails          String?
  computersNeeded      Boolean @default(false)
  computersQuantity    Int?
  otherDevRequirements String?

  // Additional
  notes           String?
  estimatedBudget Float?
  priority        Priority @default(MEDIUM)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  visit SchoolVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@map("school_requirements")
}

model VisitImage {
  id          String   @id @default(uuid())
  visitId     String
  imageUrl    String
  imageKey    String
  imageType   String?
  description String?
  uploadedAt  DateTime @default(now())

  visit SchoolVisit @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([visitId])
  @@map("visit_images")
}

model Note {
  id         String    @id @default(uuid())
  userId     String
  title      String?
  content    String?   @db.Text
  noteType   NoteType  @default(TEXT)
  color      NoteColor @default(DEFAULT)
  isPinned   Boolean   @default(false)
  isArchived Boolean   @default(false)
  isTrashed  Boolean   @default(false)
  trashedAt  DateTime?
  schoolId   String?
  visitId    String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  school         School?             @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  visit          SchoolVisit?        @relation(fields: [visitId], references: [id], onDelete: SetNull)
  checklistItems NoteChecklistItem[]
  labels         NoteNoteLabel[]

  @@index([userId])
  @@index([schoolId])
  @@index([visitId])
  @@index([isPinned])
  @@index([isArchived])
  @@index([isTrashed])
  @@index([createdAt])
  @@map("notes")
}

model NoteChecklistItem {
  id          String   @id @default(uuid())
  noteId      String
  text        String
  isCompleted Boolean  @default(false)
  position    Int      @default(0)
  createdAt   DateTime @default(now())

  note Note @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@map("note_checklist_items")
}

model NoteLabel {
  id          String   @id @default(uuid())
  name        String   @unique
  color       String?
  createdById String
  createdAt   DateTime @default(now())

  createdBy User            @relation("NoteLabelCreatedBy", fields: [createdById], references: [id])
  notes     NoteNoteLabel[]

  @@index([name])
  @@map("note_labels")
}

model NoteNoteLabel {
  id        String   @id @default(uuid())
  noteId    String
  labelId   String
  createdAt DateTime @default(now())

  note  Note      @relation(fields: [noteId], references: [id], onDelete: Cascade)
  label NoteLabel @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([noteId, labelId])
  @@index([noteId])
  @@index([labelId])
  @@map("note_note_labels")
}

model Chat {
  id          String   @id @default(uuid())
  type        ChatType @default(ONE_ON_ONE)
  name        String?
  isGroup     Boolean  @default(false)
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy    User?            @relation("ChatCreatedBy", fields: [createdById], references: [id])
  participants ChatParticipant[]
  messages     Message[]

  @@index([isGroup])
  @@map("chats")
}

model ChatParticipant {
  id          String          @id @default(uuid())
  chatId      String
  userId      String
  role        ParticipantRole @default(MEMBER)
  unreadCount Int             @default(0)
  joinedAt    DateTime        @default(now())

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([chatId])
  @@index([userId])
  @@map("chat_participants")
}

model Message {
  id          String      @id @default(uuid())
  chatId      String
  senderId    String
  content     String?     @db.Text
  messageType MessageType @default(TEXT)
  fileUrl     String?
  fileName    String?
  fileSize    Int?
  createdAt   DateTime    @default(now())

  chat   Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}
